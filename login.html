<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Mural Eletrônico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-primaria: #003366;
            --cor-secundaria: #00a89d;
            --cor-fundo: #f0f4f8;
        }
        body { background-color: var(--cor-fundo); font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: var(--cor-primaria); }
        .btn-primary:hover { background-color: #004488; }
        input:focus, select:focus {
            border-color: var(--cor-primaria);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.2);
        }
        .tab { border-color: transparent; }
        .tab.active {
            border-color: var(--cor-primaria);
            color: var(--cor-primaria);
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--cor-primaria);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p id="loading-message" class="mt-4 text-lg font-medium text-gray-600">Processando...</p>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-center text-[var(--cor-primaria)] mb-2">Mural Eletrônico</h1>
        <p class="text-center text-gray-500 mb-6">Acesse ou crie sua conta</p>

        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="login-tab" class="tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Login</button>
                <button id="register-tab" class="tab text-gray-500 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Cadastro</button>
            </nav>
        </div>

        <form id="auth-form">
            <div class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium">Email</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium">Senha</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                </div>
            </div>

            <!-- Registration Fields -->
            <div id="register-fields" class="hidden space-y-4 mt-4">
                <div>
                    <label for="confirm-password" class="block text-sm font-medium">Confirmar Senha</label>
                    <input type="password" id="confirm-password" name="confirm-password" class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                </div>
                <div>
                    <label for="unidade" class="block text-sm font-medium">Unidade</label>
                    <select id="unidade" name="unidade" class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                        <option value="" disabled selected>Selecione sua unidade</option>
                        <option value="unidade_a">Unidade A</option>
                        <option value="unidade_b">Unidade B</option>
                        <option value="unidade_c">Unidade C</option>
                    </select>
                </div>
            </div>

            <div id="error-message" class="hidden mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-md"></div>

            <button type="submit" class="mt-6 w-full btn-primary text-white font-bold py-2.5 px-4 rounded-lg transition-transform transform hover:scale-105">
                <span id="button-text">Entrar</span>
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userFirebaseConfig = {
             apiKey: "AIzaSyCG-HiSw5h5Soir5c5z3iBbE6UoA6EuuBA",
            authDomain: "mural-eletronico-nav.firebaseapp.com",
            projectId: "mural-eletronico-nav",
            storageBucket: "mural-eletronico-nav.firebasestorage.app",
            messagingSenderId: "715537886137",
            appId: "1:715537886-web:f715e8fc9438df82722468",
            measurementId: "G-T2LLX_J94V"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mural-app';

        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const registerFields = document.getElementById('register-fields');
        const buttonText = document.getElementById('button-text');
        const form = document.getElementById('auth-form');
        const errorMessage = document.getElementById('error-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');

        const confirmPasswordInput = document.getElementById('confirm-password');
        const unidadeSelect = document.getElementById('unidade');

        let isLoginMode = true;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("DEBUG: Usuário autenticado detectado. UID:", user.uid);
                loadingMessage.textContent = 'Verificando perfil...';
                loadingOverlay.classList.remove('hidden');

                try {
                    const userProfilePath = `artifacts/${appId}/public/data/user_profiles/${user.uid}`;
                    console.log("DEBUG: Tentando buscar perfil em:", userProfilePath);
                    const userProfileRef = doc(db, userProfilePath);
                    const docSnap = await getDoc(userProfileRef);

                    if (docSnap.exists()) {
                        console.log("DEBUG: Perfil encontrado:", docSnap.data());
                        loadingMessage.textContent = 'Acesso verificado. Redirecionando...';
                        window.location.href = 'admin.html';
                    } else {
                        console.error("DEBUG: ERRO CRÍTICO - Perfil não encontrado no banco de dados.");
                        await signOut(auth);
                        errorMessage.textContent = 'Seu perfil não foi encontrado. Por favor, tente se cadastrar novamente.';
                        errorMessage.classList.remove('hidden');
                        loadingOverlay.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("DEBUG: ERRO ao buscar perfil:", error);
                    await signOut(auth);
                    errorMessage.textContent = 'Ocorreu um erro ao verificar seu perfil. Tente novamente.';
                    errorMessage.classList.remove('hidden');
                    loadingOverlay.classList.add('hidden');
                }
            } else {
                console.log("DEBUG: Nenhum usuário autenticado.");
                loadingOverlay.classList.add('hidden');
            }
        });

        function setMode(newModeIsLogin) {
            isLoginMode = newModeIsLogin;
            errorMessage.classList.add('hidden');
            if (isLoginMode) {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                registerFields.classList.add('hidden');
                buttonText.textContent = 'Entrar';
                confirmPasswordInput.required = false;
                unidadeSelect.required = false;
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                registerFields.classList.remove('hidden');
                buttonText.textContent = 'Criar Conta';
                confirmPasswordInput.required = true;
                unidadeSelect.required = true;
            }
        }
        
        loginTab.addEventListener('click', () => setMode(true));
        registerTab.addEventListener('click', () => setMode(false));
        
        setMode(true);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.classList.add('hidden');
            loadingMessage.textContent = isLoginMode ? 'Entrando...' : 'Criando conta...';
            loadingOverlay.classList.remove('hidden');

            const email = form.email.value;
            const password = form.password.value;

            try {
                if (isLoginMode) {
                    console.log("DEBUG: Tentando fazer login...");
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    console.log("DEBUG: Tentando criar nova conta...");
                    const confirmPassword = confirmPasswordInput.value;
                    const unidadeId = unidadeSelect.value;
                    if (password !== confirmPassword) throw new Error("As senhas não coincidem.");
                    if (!unidadeId) throw new Error("Por favor, selecione uma unidade.");
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    const userProfilePath = `artifacts/${appId}/public/data/user_profiles/${user.uid}`;
                    console.log("DEBUG: Tentando criar perfil de usuário em:", userProfilePath);
                    const userProfileRef = doc(db, userProfilePath);
                    await setDoc(userProfileRef, { unidadeId: unidadeId, email: user.email });
                    console.log("DEBUG: Perfil criado com sucesso para o usuário:", user.uid);
                }
            } catch (error) {
                console.error("DEBUG: Erro no formulário de autenticação:", error);
                errorMessage.textContent = error.message.includes("auth/invalid-credential") ? "Email ou senha inválidos." : error.message;
                errorMessage.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
            }
        });

    </script>
</body>
</html>

