<!DOCTYPE html>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, setDoc, getDoc, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ... (resto das importações)

        // ... (seletores de elementos DOM, como authContainer, adminContent, etc.)
        const comunicadosStatusMsg = document.getElementById('comunicados-status-msg');
        
        try {
            // ... (configuração do Firebase, que já está correta)

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Usuário autenticado:", user.email); // LOG DE DIAGNÓSTICO
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        console.log("Dados do usuário encontrados:", userData); // LOG DE DIAGNÓSTICO

                        // ... (verificação de status 'pending')

                        document.getElementById('unidade').value = userData.unidade;
                        loadComunicados(userData.unidade);

                        if (userData.role === 'master') {
                            console.log("Usuário é MASTER. Carregando painel de aprovação."); // LOG DE DIAGNÓSTICO
                            approvalSection.classList.remove('hidden');
                            loadPendingUsers();
                        }
                    } else {
                        console.error("Documento do usuário NÃO encontrado no Firestore para o UID:", user.uid); // LOG DE DIAGNÓSTICO
                        // ...
                    }
                } else {
                    console.log("Nenhum usuário logado."); // LOG DE DIAGNÓSTICO
                    // ... (lógica de logout)
                }
            });

            // ... (código dos formulários de login e cadastro)

            function loadComunicados(unidadeDoUsuario) {
                console.log(`Iniciando loadComunicados para a unidade: "${unidadeDoUsuario}"`); // LOG DE DIAGNÓSTICO
                
                if (unsubscribeListener) { unsubscribeListener(); }
                if (!unidadeDoUsuario) {
                    console.error("loadComunicados falhou: unidadeDoUsuario está vazia."); // LOG DE DIAGNÓSTICO
                    comunicadosStatusMsg.textContent = 'Unidade do usuário não encontrada.';
                    return;
                }
                
                comunicadosStatusMsg.textContent = `Carregando comunicados para ${unidadeDoUsuario}...`;
                comunicadosStatusMsg.style.display = 'block';

                const comunicadosRef = collection(db, "artifacts/default-mural-app/public/data/comunicados");
                const q = query(comunicadosRef, where("unidade", "==", unidadeDoUsuario));
                console.log("Query dos Comunicados criada:", q); // LOG DE DIAGNÓSTICO

                unsubscribeListener = onSnapshot(q, (snapshot) => {
                    console.log(`Snapshot dos Comunicados recebido. Documentos encontrados: ${snapshot.size}`); // LOG DE DIAGNÓSTICO
                    const listContainer = document.getElementById('comunicados-list');
                    listContainer.innerHTML = ''; 

                    if (snapshot.empty) {
                        comunicadosStatusMsg.textContent = `Nenhum comunicado cadastrado para a unidade ${unidadeDoUsuario}.`;
                        comunicadosStatusMsg.style.display = 'block';
                        return;
                    }
                    
                    comunicadosStatusMsg.style.display = 'none';
                    // ... (resto da função que renderiza a lista)
                }, (error) => {
                    console.error("ERRO no onSnapshot dos Comunicados:", error); // LOG DE DIAGNÓSTICO
                    comunicadosStatusMsg.textContent = 'Erro ao carregar comunicados.';
                    comunicadosStatusMsg.style.display = 'block';
                });
            }

            function loadPendingUsers() {
                console.log("Iniciando loadPendingUsers..."); // LOG DE DIAGNÓSTICO
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("status", "==", "pending"));
                console.log("Query de Usuários Pendentes criada:", q); // LOG DE DIAGNÓSTICO

                onSnapshot(q, (snapshot) => {
                    console.log(`Snapshot de Usuários Pendentes recebido. Documentos encontrados: ${snapshot.size}`); // LOG DE DIAGNÓSTICO
                    if (snapshot.empty) {
                        pendingUsersList.innerHTML = '<p class="text-gray-500">Nenhum usuário aguardando aprovação.</p>';
                        return;
                    }

                    pendingUsersList.innerHTML = '';
                    // ... (resto da função que renderiza a lista)
                }, (error) => {
                    console.error("ERRO no onSnapshot dos Usuários Pendentes:", error); // LOG DE DIAGNÓSTICO
                });
            }

            // ... (Resto do seu código)

        } catch(error) {
            console.error("Erro de inicialização:", error);
            showError(loginError, `Erro Crítico: ${error.message}`);
        }
    </script>
</body>
</html>
