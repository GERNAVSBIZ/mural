<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração do Mural</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-primaria: #003366;
            --cor-secundaria: #00a89d;
            --cor-fundo: #f0f4f8;
            --cor-texto: #333333;
            --cor-branco: #ffffff;
            --cor-erro: #e53e3e;
            --cor-progresso: #2dd4bf;
        }
        body { background-color: var(--cor-fundo); font-family: 'Inter', sans-serif; color: var(--cor-texto); }
        .header { background-color: var(--cor-primaria); color: var(--cor-branco); }
        .btn-primary { background-color: var(--cor-primaria); color: var(--cor-branco); }
        .btn-primary:hover { background-color: #004488; }
        .btn-primary:disabled { background-color: #667b99; cursor: not-allowed; }
        .btn-danger { background-color: var(--cor-erro); color: var(--cor-branco); }
        .btn-danger:hover { background-color: #c53030; }
        input:focus, textarea:focus, select:focus {
            border-color: var(--cor-primaria);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.2);
        }
        .progress-bar-bg { background-color: #e0e0de; border-radius: 9999px; }
        .progress-bar-fill { background-color: var(--cor-progresso); border-radius: 9999px; transition: width 0.3s ease-in-out; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--cor-primaria);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen">

    <div id="loading-screen" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg font-medium text-gray-600">Verificando acesso...</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header class="header shadow-md p-4 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-center">Painel de Administração</h1>
            <div>
                <span id="user-info" class="text-sm mr-4 hidden md:inline"></span>
                <button id="logout-button" class="text-sm font-medium bg-white text-[var(--cor-primaria)] px-3 py-1.5 rounded-md hover:bg-gray-100 transition">Sair</button>
            </div>
        </header>

        <div id="error-container" class="hidden container mx-auto p-4 md:px-8 mt-4">
            <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative"></div>
        </div>
        
        <main class="container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-[var(--cor-primaria)] border-b pb-2">Adicionar Novo Comunicado</h2>
                <form id="add-comunicado-form" class="space-y-4">
                    <div>
                        <label for="titulo" class="block text-sm font-medium">Título</label>
                        <input type="text" id="titulo" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                    </div>
                    <div>
                        <label for="type" class="block text-sm font-medium">Tipo de Comunicado</label>
                        <select id="type" class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                            <option value="text_image" selected>Texto e Imagem</option>
                            <option value="image_only">Somente Imagem</option>
                            <option value="iframe">Página Web (iframe)</option>
                        </select>
                    </div>

                    <div id="fields-text-image" class="space-y-4">
                        <div>
                            <label for="imageUpload" class="block text-sm font-medium">Imagem</label>
                            <input type="file" id="imageUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[var(--cor-secundaria)] file:text-white hover:file:bg-opacity-80">
                        </div>
                        <div id="upload-progress-container" class="hidden space-y-2">
                            <label class="block text-sm font-medium">Progresso do Upload</label>
                            <div class="progress-bar-bg w-full h-2.5">
                                <div id="upload-progress-bar" class="progress-bar-fill h-2.5" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="texto-container">
                            <label for="texto" class="block text-sm font-medium">Texto do Comunicado</label>
                            <textarea id="texto" rows="4" class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300"></textarea>
                        </div>
                    </div>

                    <div id="fields-iframe" class="hidden space-y-4">
                        <div>
                            <label for="url" class="block text-sm font-medium">URL da Página Web</label>
                            <input type="url" id="url" class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300" placeholder="https://site-a-ser-exibido.com">
                        </div>
                    </div>
                    
                    <div>
                        <label for="duracao" class="block text-sm font-medium">Duração (em segundos)</label>
                        <input type="number" id="duracao" value="10" min="1" class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm border border-gray-300">
                    </div>
                    <button type="submit" id="submit-button" class="btn-primary font-bold py-2 px-4 rounded-lg w-full transition-transform transform hover:scale-105">
                        Adicionar Comunicado
                    </button>
                </form>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-[var(--cor-primaria)] border-b pb-2">Comunicados Atuais</h2>
                <div id="comunicados-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <p id="loading-list">Verificando...</p>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const userFirebaseConfig = {
            apiKey: "AIzaSyCG-HiSw5h5Soir5c5z3iBbE6UoA6EuuBA",
            authDomain: "mural-eletronico-nav.firebaseapp.com",
            projectId: "mural-eletronico-nav",
            storageBucket: "mural-eletronico-nav.firebasestorage.app",
            messagingSenderId: "715537886137",
            appId: "1:715537886137:web:f715e8fc9438df82722468",
            measurementId: "G-T2LLX_J94V"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mural-app';

        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        
        let comunicadosCollection;
        let currentUserUnidadeId;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const attemptToFetchProfile = async (retries = 4, delay = 750) => {
                    for (let i = 0; i < retries; i++) {
                        const userProfileRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, user.uid);
                        const userProfileSnap = await getDoc(userProfileRef);
                        if (userProfileSnap.exists()) {
                            return userProfileSnap;
                        }
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                        }
                    }
                    return null;
                };

                const userProfileSnap = await attemptToFetchProfile();

                if (userProfileSnap) {
                    currentUserUnidadeId = userProfileSnap.data().unidadeId;
                    document.getElementById('user-info').textContent = `Unidade: ${currentUserUnidadeId.replace('_', ' ')}`;
                    comunicadosCollection = collection(db, `artifacts/${appId}/public/data/unidades/${currentUserUnidadeId}/comunicados`);
                    loadComunicados();
                    
                    loadingScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                } else {
                    // **CORREÇÃO APLICADA AQUI**
                    // Em vez de deslogar e causar o loop, mostramos um erro claro.
                    loadingScreen.classList.add('hidden');
                    showError("Não foi possível carregar seu perfil de usuário. Por favor, tente fazer o login novamente. Se o problema persistir, contate o suporte.");
                    // Ocultamos o painel principal, mas deixamos o botão de sair visível.
                    document.querySelector('main').classList.add('hidden');
                    appContainer.classList.remove('hidden');
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        
        function showError(message) {
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('error-message').innerHTML = `<strong class="font-bold">Erro:</strong> ${message}`;
        }
        
        const typeSelect = document.getElementById('type');
        const fieldsTextImage = document.getElementById('fields-text-image');
        const fieldsIframe = document.getElementById('fields-iframe');
        const textoContainer = document.getElementById('texto-container');

        typeSelect.addEventListener('change', () => {
            fieldsIframe.classList.toggle('hidden', typeSelect.value !== 'iframe');
            fieldsTextImage.classList.toggle('hidden', typeSelect.value === 'iframe');
            textoContainer.classList.toggle('hidden', typeSelect.value === 'image_only');
        });

        const form = document.getElementById('add-comunicado-form');
        const submitButton = document.getElementById('submit-button');
        const progressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('upload-progress-bar');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!comunicadosCollection) return showError("Não foi possível conectar ao banco de dados.");

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            const newComunicado = {
                titulo: form.titulo.value.trim(),
                type: form.type.value,
                duracao: parseInt(form.duracao.value, 10),
                createdAt: new Date(),
            };

            const file = form.imageUpload.files[0];

            if (newComunicado.type === 'text_image' || newComunicado.type === 'image_only') {
                if (file) {
                    const storageRef = ref(storage, `images/${currentUserUnidadeId}/${Date.now()}_${file.name}`);
                    const uploadTask = uploadBytesResumable(storageRef, file);
                    progressContainer.classList.remove('hidden');

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                        }, 
                        (error) => {
                            showError("O upload da imagem falhou.");
                            resetFormState();
                        }, 
                        async () => {
                            newComunicado.imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                            if (newComunicado.type === 'text_image') newComunicado.texto = form.texto.value.trim();
                            saveComunicado(newComunicado);
                        }
                    );
                } else {
                    if(newComunicado.type === 'image_only') {
                         showError("Para 'Somente Imagem', você precisa selecionar um arquivo de imagem.");
                         resetFormState();
                         return;
                    }
                    newComunicado.texto = form.texto.value.trim();
                    saveComunicado(newComunicado);
                }
            } else if (newComunicado.type === 'iframe') {
                newComunicado.url = form.url.value.trim();
                saveComunicado(newComunicado);
            }
        });

        async function saveComunicado(comunicadoData) {
             try {
                await addDoc(comunicadosCollection, comunicadoData);
                resetFormState();
            } catch (error) {
                showError("Não foi possível salvar o comunicado.");
                resetFormState();
            }
        }
        
        function resetFormState() {
            form.reset();
            typeSelect.dispatchEvent(new Event('change'));
            submitButton.disabled = false;
            submitButton.textContent = 'Adicionar Comunicado';
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        }

        function loadComunicados() {
            const q = query(comunicadosCollection, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('comunicados-list');
                if (snapshot.empty) return listContainer.innerHTML = '<p>Nenhum comunicado cadastrado para esta unidade.</p>';
                listContainer.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'border p-4 rounded-lg bg-gray-50 flex justify-between items-start';
                    
                    let typeLabel;
                    let description;
                    
                    switch(data.type) {
                        case 'iframe':
                            typeLabel = 'Página Web';
                            description = data.url;
                            break;
                        case 'image_only':
                            typeLabel = 'Somente Imagem';
                            description = 'Exibição de imagem em tela cheia.';
                            break;
                        default:
                            typeLabel = 'Texto/Imagem';
                            description = (data.texto || '').substring(0, 50) + '...';
                            break;
                    }

                    div.innerHTML = `
                        <div>
                            <h3 class="font-bold">${data.titulo}</h3>
                            <p class="text-sm text-gray-600 break-all">${description}</p>
                            <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full mt-2 inline-block">${typeLabel}</span>
                        </div>
                        <button data-id="${docSnap.id}" class="delete-btn btn-danger text-sm py-1 px-3 rounded-md flex-shrink-0 ml-4">Excluir</button>
                    `;
                    listContainer.appendChild(div);
                });

                listContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        await deleteDoc(doc(comunicadosCollection, id));
                    });
                });
            });
        }
    </script>
</body>
</html>

