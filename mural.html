<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mural Eletrônico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-primaria: #003366;
            --cor-secundaria: #00a89d;
            --cor-fundo: #f0f4f8;
            --cor-texto: #333333;
            --cor-branco: #ffffff;
            --cor-progresso: #00a89d;
        }
        html, body {
            overflow: hidden;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--cor-fundo);
            font-family: 'Inter', sans-serif;
        }
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            visibility: hidden;
        }
        .slide.active {
            opacity: 1;
            visibility: visible;
        }
        #progress-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(0,0,0,0.1);
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--cor-progresso);
            transition: width 0.1s linear;
        }
        .conteudo-texto {
            line-height: 1.6;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="flex flex-col">

    <div id="slides-container" class="relative w-full h-full">
        <div id="loading-state" class="w-full h-full flex flex-col items-center justify-center text-gray-500">
            <svg class="animate-spin h-8 w-8 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text">Conectando ao servidor de comunicados...</p>
        </div>
    </div>

    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const loadingState = document.getElementById('loading-state');
        const loadingText = document.getElementById('loading-text');

        try {
            const userFirebaseConfig = {
                apiKey: "AIzaSyCG-HiSw5h5Soir5c5z3iBbE6UoA6EuuBA",
                authDomain: "mural-eletronico-nav.firebaseapp.com",
                projectId: "mural-eletronico-nav",
                storageBucket: "mural-eletronico-nav.appspot.com",
                messagingSenderId: "715537886137",
                appId: "1:715537886137:web:f715e8fc9438df82722468",
                measurementId: "G-T2LLX1J94V"
            };
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
             if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Configuração do Firebase não encontrada.");
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mural-app';
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let comunicadosCollection;

            onAuthStateChanged(auth, user => {
                if (user) {
                    loadingText.textContent = 'Buscando comunicados...';
                    comunicadosCollection = collection(db, `artifacts/${appId}/public/data/comunicados`);
                    setupCarousel();
                }
            });

            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch(authError) {
                    loadingText.textContent = "Falha na autenticação. Verifique a API Key e se o Login Anônimo está ativo no Firebase.";
                }
            })();

            let comunicados = [];
            let currentSlide = 0;
            let slideInterval;
            const progressBar = document.getElementById('progress-bar');
            let progressInterval;

            function setupCarousel() {
                const q = query(collection(db, `artifacts/${appId}/public/data/comunicados`), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    comunicados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSlides();
                    if (comunicados.length > 0) {
                        loadingState.style.display = 'none';
                        startCarousel();
                    } else {
                        loadingState.style.display = 'flex';
                        loadingText.textContent = 'Nenhum comunicado para exibir. Adicione um no painel de administração.';
                    }
                });
            }
            
            function renderSlides() {
                const container = document.getElementById('slides-container');
                container.innerHTML = ''; // Limpa slides antigos
                comunicados.forEach((comunicado, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'slide';
                    slide.dataset.index = index;
                    
                    let slideContent = '';

                    if (comunicado.type === 'iframe' && comunicado.url) {
                         slideContent = `
                            <div class="w-full h-full flex flex-col bg-white">
                                <header class="bg-[var(--cor-primaria)] text-white p-4 flex-shrink-0">
                                    <h1 class="text-2xl font-bold text-center">${comunicado.titulo}</h1>
                                </header>
                                <iframe src="${comunicado.url}" class="w-full h-full border-0"></iframe>
                            </div>`;
                    } else if (comunicado.imageOnly && comunicado.imageUrl) {
                        // NOVO: Layout para imagem sem texto
                        slideContent = `
                            <div class="w-full h-full flex items-center justify-center p-6 bg-black">
                                <img src="${comunicado.imageUrl}" alt="${comunicado.titulo}" class="max-w-full max-h-full object-contain rounded-lg">
                            </div>`;
                    } else {
                        // Layout padrão com texto e imagem
                        const hasImage = comunicado.imageUrl;
                        const gridCols = hasImage ? 'grid-cols-2' : 'grid-cols-1';
                        
                        slideContent = `
                            <div class="w-full h-full flex flex-col">
                                <header class="bg-[var(--cor-primaria)] text-white p-4 flex-shrink-0">
                                    <h1 class="text-3xl font-bold text-center">${comunicado.titulo}</h1>
                                </header>
                                <main class="flex-grow p-8 grid ${gridCols} gap-8 items-center">
                                    <div class="conteudo-texto text-2xl text-gray-700 ${!hasImage ? 'col-span-1' : ''} h-full overflow-y-auto">
                                        ${comunicado.texto ? comunicado.texto.replace(/\n/g, '<br>') : ''}
                                    </div>
                                    ${hasImage ? `<div class="flex items-center justify-center h-full">
                                                    <img src="${comunicado.imageUrl}" alt="${comunicado.titulo}" class="max-w-full max-h-full object-contain rounded-lg">
                                                </div>` : ''}
                                </main>
                            </div>`;
                    }
                    slide.innerHTML = slideContent;
                    container.appendChild(slide);
                });
            }

            function startCarousel() {
                clearInterval(slideInterval);
                if (comunicados.length === 0) return;
                
                currentSlide = 0; // Sempre começa do primeiro slide
                showSlide(currentSlide);
            }

            function showSlide(index) {
                const slides = document.querySelectorAll('.slide');
                slides.forEach(slide => slide.classList.remove('active'));
                
                const activeSlide = document.querySelector(`.slide[data-index='${index}']`);
                if(activeSlide) activeSlide.classList.add('active');

                const duration = (comunicados[index].duracao || 10) * 1000;

                // Progress bar
                clearInterval(progressInterval);
                progressBar.style.transition = 'none';
                progressBar.style.width = '0%';
                
                setTimeout(() => {
                    progressBar.style.transition = `width ${duration / 1000}s linear`;
                    progressBar.style.width = '100%';
                }, 50);

                // Troca para o próximo slide
                slideInterval = setTimeout(nextSlide, duration);
            }

            function nextSlide() {
                currentSlide = (currentSlide + 1) % comunicados.length;
                showSlide(currentSlide);
            }
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    startCarousel();
                } else {
                    clearInterval(slideInterval);
                    clearInterval(progressInterval);
                }
            });

        } catch(error) {
            console.error("Erro de inicialização:", error);
            loadingText.textContent = error.message;
        }
    </script>
</body>
</html>

