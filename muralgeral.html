<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mural Eletrônico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-primaria: #003366;
            --cor-secundaria: #00a89d;
            --cor-fundo: #f0f4f8;
            --cor-progresso: #00a89d;
        }
        html, body {
            overflow: hidden;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--cor-fundo);
            font-family: 'Inter', sans-serif;
        }
        .slide {
            position: absolute; width: 100%; height: 100%;
            opacity: 0; transition: opacity 1s ease-in-out; visibility: hidden;
        }
        .slide.active { opacity: 1; visibility: visible; }
        #progress-bar-container {
            position: fixed; bottom: 0; left: 0;
            width: 100%; height: 5px; background-color: rgba(0,0,0,0.1);
        }
        #progress-bar {
            width: 0%; height: 100%; background-color: var(--cor-progresso);
            transition: width 0.1s linear;
        }
        #unit-selection button {
            background-color: var(--cor-primaria);
            transition: background-color 0.3s;
        }
        #unit-selection button:hover {
            background-color: #004488;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="flex flex-col">
    <!-- Tela de Seleção de Unidade -->
    <div id="unit-selection" class="w-full h-full flex flex-col items-center justify-center p-8">
        <h1 class="text-4xl font-bold text-[var(--cor-primaria)] mb-8">Selecione a Unidade</h1>
        <div id="unit-list" class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <!-- As unidades serão inseridas aqui pelo JS -->
        </div>
    </div>

    <!-- Container dos Slides -->
    <div id="mural-view" class="hidden relative w-full h-full">
        <div id="slides-container" class="w-full h-full">
             <div id="loading-state" class="w-full h-full flex flex-col items-center justify-center text-gray-500">
                <p id="loading-text">Carregando...</p>
            </div>
        </div>
        <button id="change-unit-button" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 text-sm rounded-full hover:bg-opacity-75">Trocar Unidade</button>
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const userFirebaseConfig = {
            apiKey: "AIzaSyCG-HiSw5h5Soir5c5z3iBbE6UoA6EuuBA",
            authDomain: "mural-eletronico-nav.firebaseapp.com",
            projectId: "mural-eletronico-nav",
            storageBucket: "mural-eletronico-nav.appspot.com",
            messagingSenderId: "715537886137",
            appId: "1:715537886137:web:f715e8fc9438df82722468",
            measurementId: "G-T2LLX1J94V"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mural-app';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Lista de Unidades (pode ser movida para o Firebase no futuro)
        const unidades = ["MATRIZ", "CINDCTA_I", "CINDCTA_II", "DTCEA_IZ"];
        
        const unitSelectionView = document.getElementById('unit-selection');
        const muralView = document.getElementById('mural-view');
        const unitListContainer = document.getElementById('unit-list');
        const loadingText = document.getElementById('loading-text');

        let unsubscribe; // Para parar de ouvir updates quando trocar de unidade

        // Renderiza os botões de seleção de unidade
        unidades.forEach(unidade => {
            const button = document.createElement('button');
            button.className = "text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg";
            button.textContent = unidade.replace('_', ' ');
            button.dataset.unidadeId = unidade;
            button.addEventListener('click', () => selectUnit(unidade));
            unitListContainer.appendChild(button);
        });

        document.getElementById('change-unit-button').addEventListener('click', () => {
            localStorage.removeItem('selectedUnidade');
            if (unsubscribe) unsubscribe();
            muralView.classList.add('hidden');
            unitSelectionView.classList.remove('hidden');
        });
        
        function selectUnit(unidadeId) {
            localStorage.setItem('selectedUnidade', unidadeId);
            unitSelectionView.classList.add('hidden');
            muralView.classList.remove('hidden');
            initializeMural(unidadeId);
        }

        // Verifica se uma unidade já foi selecionada
        (async () => {
            await signInAnonymously(auth); // Mural precisa de auth anônima para ler os dados
            const savedUnit = localStorage.getItem('selectedUnidade');
            if (savedUnit && unidades.includes(savedUnit)) {
                selectUnit(savedUnit);
            }
        })();


        let comunicados = [];
        let currentSlide = 0;
        let slideInterval;
        const progressBar = document.getElementById('progress-bar');
        
        function initializeMural(unidadeId) {
            loadingText.textContent = `Buscando comunicados para ${unidadeId.replace('_', ' ')}...`;
            
            if (unsubscribe) unsubscribe();

            const comunicadosCollection = collection(db, `artifacts/${appId}/public/data/unidades/${unidadeId}/comunicados`);
            const q = query(comunicadosCollection, orderBy("createdAt", "desc"));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                comunicados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSlides();
                if (comunicados.length > 0) {
                    document.getElementById('loading-state').style.display = 'none';
                    startCarousel();
                } else {
                    document.getElementById('loading-state').style.display = 'flex';
                    loadingText.textContent = 'Nenhum comunicado para exibir nesta unidade.';
                }
            });
        }
        
        function renderSlides() {
            const container = document.getElementById('slides-container');
            // Limpa slides antigos mas mantém o loading state
            const loading = document.getElementById('loading-state');
            container.innerHTML = '';
            container.appendChild(loading);
            
            comunicados.forEach((comunicado, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.dataset.index = index;
                
                let slideContent = '';
                if (comunicado.type === 'iframe') {
                     slideContent = `<div class="w-full h-full flex flex-col bg-white"><header class="bg-[var(--cor-primaria)] text-white p-4 flex-shrink-0"><h1 class="text-2xl font-bold text-center">${comunicado.titulo}</h1></header><iframe src="${comunicado.url}" class="w-full h-full border-0"></iframe></div>`;
                } else if (comunicado.type === 'image_only') {
                    slideContent = `<div class="w-full h-full flex flex-col"><header class="bg-[var(--cor-primaria)] text-white p-4 flex-shrink-0"><h1 class="text-3xl font-bold text-center">${comunicado.titulo}</h1></header><main class="flex-grow flex items-center justify-center p-4 bg-black"><img src="${comunicado.imageUrl}" alt="${comunicado.titulo}" class="max-w-full max-h-full object-contain"></main></div>`;
                } else { // text_image
                    const hasImage = comunicado.imageUrl;
                    const gridCols = hasImage ? 'grid-cols-2' : 'grid-cols-1';
                    slideContent = `<div class="w-full h-full flex flex-col"><header class="bg-[var(--cor-primaria)] text-white p-4 flex-shrink-0"><h1 class="text-3xl font-bold text-center">${comunicado.titulo}</h1></header><main class="flex-grow p-8 grid ${gridCols} gap-8 items-center"><div class="text-2xl text-gray-700 h-full overflow-y-auto">${(comunicado.texto || '').replace(/\n/g, '<br>')}</div>${hasImage ? `<div class="flex items-center justify-center h-full"><img src="${comunicado.imageUrl}" alt="${comunicado.titulo}" class="max-w-full max-h-full object-contain rounded-lg"></div>` : ''}</main></div>`;
                }
                slide.innerHTML = slideContent;
                container.appendChild(slide);
            });
        }

        function startCarousel() {
            clearInterval(slideInterval);
            if (comunicados.length === 0) return;
            currentSlide = 0;
            showSlide(currentSlide);
        }

        function showSlide(index) {
            const slides = document.querySelectorAll('.slide');
            slides.forEach(slide => slide.classList.remove('active'));
            const activeSlide = document.querySelector(`.slide[data-index='${index}']`);
            if(activeSlide) activeSlide.classList.add('active');

            const duration = (comunicados[index]?.duracao || 10) * 1000;

            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.transition = `width ${duration / 1000}s linear`;
                progressBar.style.width = '100%';
            }, 50);

            slideInterval = setTimeout(nextSlide, duration);
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % comunicados.length;
            showSlide(currentSlide);
        }
    </script>
</body>
</html>

